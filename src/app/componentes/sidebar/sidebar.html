<div id="sidebar" [style.display]="visible ? 'flex' : 'none'" [class.collapsed]="isCollapsed"
  [class.light-mode]="isLightMode">
  <div class="sidebar-content">
    <div class="sidebar-section">
      <h3>Vistas</h3>
      <div class="sidebar-item" (click)="cargarMiDia()">
        <i class="fas fa-sun"></i>
        <span>Mi día</span>
      </div>
      <div class="sidebar-item" (click)="cargarMiSemana()">
        <i class="fa-solid fa-calendar-week"></i>
        <span>Mi semana</span>
      </div>
      <div class="sidebar-item" (click)="cargarTodasLasTareas()">
        <i class="fas fa-th-list"></i>
        <span>Mis tareas</span>
      </div>
      <div class="sidebar-item" (click)="filtrarPorEstado('P')">
        <i class="far fa-clock"></i>
        <span>Pendientes</span>
      </div>
      <div class="sidebar-item" (click)="filtrarPorEstado('N')">
        <i class="fas fa-spinner"></i>
        <span>En progreso</span>
      </div>
      <div class="sidebar-item" (click)="filtrarPorEstado('C')">
        <i class="fas fa-check-circle"></i>
        <span>Completadas</span>
      </div>
      <div class="sidebar-item" (click)="cargarTareasVencidas()">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Vencidas</span>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Tools</h3>
      <div class="sidebar-item" (click)="mostrarListasIndividuales()">
        <i class="fas fa-list"></i>
        <span>Mis listas</span>
      </div>
      <div class="sidebar-item" (click)="mostrarListasImportantes()">
        <i class="fas fa-star"></i>
        <span>Listas importantes</span>
      </div>
      <div class="sidebar-item" (click)="mostrarListasCompartidas()">
        <i class="fa-solid fa-users"></i>
        <span>Listas compartidas</span>
      </div>
      <div class="sidebar-item" (click)="mostrarCalendario()">
        <i class="far fa-calendar"></i>
        <span>Calendario</span>
      </div>
      <div class="sidebar-item" (click)="mostrarNotas()">
        <i class="far fa-sticky-note"></i>
        <span>Notas</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-header">
        <h3>Tableros</h3>
        <button class="btn-add-categoria" (click)="abrirModalCategoria()" title="Agregar categoría">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <div id="sidebarCategorias">
        <!-- Categorías con sus listas -->
        <div *ngFor="let categoria of categorias" class="sidebar-categoria">
          <div class="sidebar-categoria-header">
            <div class="categoria-nombre-clickeable" (click)="verTablero(categoria.idCategoria)">
              <i class="fas" [ngClass]="
                  isCategoriaExpandida(categoria.idCategoria)
                    ? 'fa-chevron-down'
                    : 'fa-chevron-right'
                " (click)="toggleCategoria(categoria.idCategoria); $event.stopPropagation()"></i>
              <span>{{ categoria.nombre }}</span>
            </div>
            <div class="categoria-actions">
              <button class="btn-share-categoria" (click)="toggleCompartirListas(categoria, $event)"
                title="Compartir listas">
                <i class="fas fa-share-alt"></i>
              </button>
              <button class="btn-add-lista" (click)="abrirModalLista(categoria.idCategoria, $event)"
                title="Agregar lista">
                <i class="fas fa-plus"></i>
              </button>
              <button class="btn-delete-categoria" (click)="confirmarEliminarCategoria(categoria, $event)"
                title="Eliminar categoría">
                <i class="fas fa-trash"></i>
              </button>
              <span class="count">{{ categoria.listas?.length || 0 }}</span>
            </div>
          </div>

          <!-- Card flotante de listas para compartir -->
          <div class="listas-compartir-dropdown"
            *ngIf="categoriaCompartirAbierta?.idCategoria === categoria.idCategoria" (click)="$event.stopPropagation()">
            <div class="listas-compartir-header">
              <h4>Compartir listas de "{{ categoria.nombre }}"</h4>
              <button class="btn-close-dropdown" (click)="cerrarCompartirListas()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="listas-compartir-content">
              <div *ngIf="categoria.listas && categoria.listas.length > 0">
                <div *ngFor="let lista of categoria.listas" class="lista-compartir-item"
                  (click)="compartirLista(lista)">
                  <span *ngIf="esEmoji(lista.icono)" class="emoji-icon">{{ lista.icono }}</span>
                  <span *ngIf="!esEmoji(lista.icono)" class="lista-icon-wrapper"
                    [style.background-color]="lista.color || '#6554c0'">
                    <i [class]="obtenerClaseIcono(lista.icono)" class="icon-sidebar"></i>
                  </span>
                  <span class="lista-nombre">{{ lista.nombre }}</span>
                  <i class="fas fa-share-alt share-icon"></i>
                </div>
              </div>
              <div *ngIf="!categoria.listas || categoria.listas.length === 0" class="sin-listas">
                <i class="fas fa-inbox"></i>
                <p>No hay listas para compartir</p>
              </div>
            </div>
          </div>

          <div class="sidebar-listas" [style.display]="isCategoriaExpandida(categoria.idCategoria) ? 'block' : 'none'">
            <div *ngFor="let lista of categoria.listas" class="sidebar-lista-item"
              (click)="cargarTareasDeLista(lista.idLista)">
              <!-- Emoji sin fondo -->
              <span *ngIf="esEmoji(lista.icono)" class="emoji-icon">{{ lista.icono }}</span>
              <!-- Icono Font Awesome con fondo de color -->
              <span *ngIf="!esEmoji(lista.icono)" class="lista-icon-wrapper"
                [style.background-color]="lista.color || '#6554c0'">
                <i [class]="obtenerClaseIcono(lista.icono)" class="icon-sidebar"></i>
              </span>
              <span>{{ lista.nombre }}</span>
            </div>
          </div>
        </div>

        <!-- Separador antes de las listas sin categoría -->
        <div class="sidebar-separator"></div>

        <!-- Botón para agregar lista sin categoría -->
        <div class="agregar-lista-sin-categoria">
          <button class="btn-agregar-lista-suelta" (click)="abrirModalListaSinCategoria()">
            <i class="fas fa-plus"></i>
            <span>Agregar lista sin categoría</span>
          </button>
        </div>

        <!-- Listas sin categoría -->
        <div *ngFor="let lista of listasSinCategoria" class="sidebar-lista-suelta"
          (click)="cargarTareasDeLista(lista.idLista)">
          <!-- Emoji sin fondo -->
          <span *ngIf="esEmoji(lista.icono)" class="emoji-icon">{{ lista.icono }}</span>
          <!-- Icono Font Awesome con fondo de color -->
          <span *ngIf="!esEmoji(lista.icono)" class="lista-icon-wrapper"
            [style.background-color]="lista.color || '#6554c0'">
            <i [class]="obtenerClaseIcono(lista.icono)" class="icon-sidebar"></i>
          </span>
          <span>{{ lista.nombre }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer con toggle de tema -->
  <div class="sidebar-footer">
    <div class="theme-toggle" (click)="toggleTheme()">
      <i class="fas" [ngClass]="isLightMode ? 'fa-sun' : 'fa-moon'"></i>
      <div class="theme-toggle-switch" [class.active]="isLightMode"></div>
      <span class="theme-toggle-label">{{ isLightMode ? 'Claro' : 'Oscuro' }}</span>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación de categoría -->
<div *ngIf="categoriaAEliminar" class="modal-overlay categoria-modal" (click)="cancelarEliminarCategoria()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirmar eliminación</h3>
    </div>
    <div class="modal-body">
      <p>
        ¿Estás seguro que deseas eliminar la lista
        <strong>"{{ categoriaAEliminar.nombre }}"</strong>?
      </p>
      <p class="advertencia">
        Esta acción también eliminará todas las tareas asociadas y no se puede deshacer.
      </p>
    </div>
    <div class="modal-footer">
      <button (click)="cancelarEliminarCategoria()" class="btn-cancelar">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button (click)="eliminarCategoria()" class="btn-confirmar-eliminar">
        <i class="fas fa-trash"></i> Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Modal de compartir -->
<app-modal-compartir [isOpen]="modalCompartirAbierto" [tipo]="tipoCompartir"
  [itemId]="itemParaCompartir?.idLista || itemParaCompartir?.idCategoria" [itemNombre]="itemParaCompartir?.nombre"
  (close)="cerrarModalCompartir()" (compartido)="alCompartir($event)">
</app-modal-compartir>