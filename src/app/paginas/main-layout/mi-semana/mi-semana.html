<div class="semana-container">
    <!-- Header -->
    <div class="semana-header">
        <div class="navegacion-wrapper">
            <div class="navegacion">
                <button class="btn-nav" (click)="semanaAnterior()">
                    <span>←</span>
                </button>
                <div class="selector-fecha">
                    <h2 class="rango-semana" (click)="toggleCalendario()">
                        {{ rangoSemana }}
                        <i class="fas fa-calendar-alt icono-calendario"></i>
                    </h2>

                    <!-- Calendario desplegable -->
                    <div class="calendario-desplegable" *ngIf="calendarioAbierto">
                        <div class="calendario-header">
                            <button class="btn-mes" (click)="mesAnteriorCalendario()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="mes-anio">{{ nombreMesCalendario }}</span>
                            <button class="btn-mes" (click)="mesSiguienteCalendario()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="calendario-dias-semana">
                            <div class="dia-semana-header" *ngFor="let dia of ['D', 'L', 'M', 'M', 'J', 'V', 'S']">
                                {{ dia }}
                            </div>
                        </div>

                        <div class="calendario-grid">
                            <button class="dia-calendario" *ngFor="let dia of diasCalendario"
                                [class.mes-actual]="dia.mesActual" [class.hoy-calendario]="esHoy(dia.fecha)"
                                [class.seleccionado-calendario]="esFechaSeleccionada(dia.fecha)"
                                (click)="seleccionarFechaCalendario(dia.fecha)">
                                {{ dia.numero }}
                            </button>
                        </div>
                    </div>
                </div>
                <button class="btn-nav" (click)="semanaSiguiente()">
                    <span>→</span>
                </button>
            </div>
        </div>
        
        <button class="btn-crear" (click)="crearTarea()">
            + Nueva Tarea
        </button>
    </div>

    <!-- Grilla de la semana -->
    <div class="grilla-semana">
        <div class="columna-dia" *ngFor="let dia of diasSemana; let i = index" [class.hoy]="esHoy(dia.fecha)"
            [class.seleccionado]="diaSeleccionado?.fecha === dia.fecha">
            <!-- Encabezado del día -->
            <div class="dia-header" (click)="seleccionarDia(dia)">
                <div class="dia-nombre">{{ dia.nombre }}</div>
                <div class="dia-numero">{{ dia.numero }}</div>
            </div>

            <!-- Tareas del día con Drag & Drop -->
            <div class="tareas-columna" cdkDropList [id]="'dia-' + i" [cdkDropListData]="dia.tareas"
                [cdkDropListConnectedTo]="getDropListIds()" (cdkDropListDropped)="onDrop($event, dia)">
                <div class="tarea-card" *ngFor="let tarea of dia.tareas" cdkDrag [cdkDragData]="tarea"
                    [class]="getPrioridadClass(tarea.prioridad)" [class.completada]="tarea.estado === 'C'"
                    (click)="seleccionarDia(dia)">
                    <div class="tarea-check">
                        <input type="checkbox" [checked]="tarea.estado === 'C'" (change)="cambiarEstadoTarea(tarea)"
                            (click)="$event.stopPropagation()" />
                    </div>

                    <div class="tarea-contenido">
                        <div class="tarea-nombre">{{ tarea.nombre }}</div>

                        <div class="tarea-meta" *ngIf="tarea.nombreLista">
                            <span *ngIf="esEmoji(tarea.iconoLista)" class="lista-emoji">
                                {{ tarea.iconoLista }}
                            </span>
                            <i *ngIf="!esEmoji(tarea.iconoLista)" [class]="obtenerClaseIcono(tarea.iconoLista)"></i>
                            <span class="lista-nombre">{{ tarea.nombreLista }}</span>
                        </div>
                    </div>
                </div>

                <div class="sin-tareas" *ngIf="dia.tareas.length === 0">Sin tareas</div>
            </div>
        </div>
    </div>

    <!-- Panel lateral de tareas del día -->
    <div class="panel-dia" *ngIf="diaSeleccionado">
        <div class="panel-header">
            <h3>
                {{ diaSeleccionado.nombre }}, {{ diaSeleccionado.numero }}
                {{ meses[diaSeleccionado.fecha.getMonth()] }}
            </h3>
            <button class="btn-cerrar" (click)="cerrarPanel()">×</button>
        </div>

        <div class="panel-content">
            <div *ngIf="diaSeleccionado.tareas.length === 0" class="sin-tareas-panel">
                No hay tareas para este día
            </div>

            <div class="lista-tareas-dia">
                <div class="tarea-completa" *ngFor="let tarea of diaSeleccionado.tareas"
                    [class.completada]="tarea.estado === 'C'">
                    <div class="tarea-check">
                        <input type="checkbox" [checked]="tarea.estado === 'C'" (change)="cambiarEstadoTarea(tarea)" />
                    </div>

                    <div class="tarea-info">
                        <div class="tarea-titulo">
                            {{ tarea.nombre }}
                        </div>
                        <div class="tarea-detalles">
                            <span class="tarea-lista" *ngIf="tarea.nombreLista">
                                <span *ngIf="esEmoji(tarea.iconoLista)" class="lista-emoji">
                                    {{ tarea.iconoLista }}
                                </span>
                                <i *ngIf="!esEmoji(tarea.iconoLista)" [class]="obtenerClaseIcono(tarea.iconoLista)"></i>
                                {{ tarea.nombreLista }}
                            </span>
                            <span [class]="'badge ' + getPrioridadClass(tarea.prioridad)">
                                {{ tarea.prioridad === 'A' ? 'Alta' : tarea.prioridad === 'B' ? 'Baja' : 'Normal' }}
                            </span>
                            <span class="tarea-vencimiento" *ngIf="tarea.fechaVencimiento">
                                <i class="far fa-calendar-alt"></i> Vence:
                                {{ tarea.fechaVencimiento | date : 'short' }}
                            </span>
                        </div>
                        <div class="tarea-descripcion" *ngIf="tarea.descripcion">
                            {{ tarea.descripcion }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Panel de creación de tarea -->
<app-panel-detalles [abierto]="panelCrearAbierto" (cerrar)="cerrarPanelCrear()" (tareaGuardada)="onTareaCreada()">
</app-panel-detalles>